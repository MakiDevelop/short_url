<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1px.tw短網址</title>
    <link rel="icon" href="/static/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-N6PZGNGN');</script>
    <!-- End Google Tag Manager -->

</head>

<body>
    <!-- NavigationBar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">1px.tw短網址</a>
            <div class="ml-auto">
                <!-- 如果使用者已登入顯示登出按鈕 -->
                <button class="btn btn-primary" onclick="window.location.href='/logout'">登出</button>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h2>我的短網址列表</h2>

        <!-- 搜尋 和 建立短網址 按鈕 在同一行 -->
        <div class="d-flex justify-content-between mb-3">
            <!-- 搜尋 -->
            <form id="search-form" method="get" action="/dashboard" class="flex-grow-1">
                <div class="input-group">
                    <input type="text" class="form-control" name="search_query" placeholder="搜尋原網址標題、Tags...">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="submit">搜尋</button>
                    </div>
                </div>
            </form>
            <!-- 建立短網址按鈕 -->
            <button class="btn btn-primary ml-3" data-toggle="modal" data-target="#createUrlModal">建立短網址</button>
        </div>

        <!-- 判斷是否有短網址 -->
        {% if urls %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>原網址標題 (OG Title)</th>
                    <th>短網址</th>
                    <th>點擊數</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="url-list">
                {% for url in urls %}
                <tr>
                    <td>{{ url.og_data.title[:25] }}{{ "..." if url.og_data.title|length > 25 else "" }}</td>
                    <td><a href="https://{{ DOMAIN }}/{{ url.short_code }}" target="_blank">https://{{ DOMAIN }}/{{
                            url.short_code }}</a></td>
                    <td>{{ url_clicks[url.short_code] }}</td> <!-- 顯示點擊數 -->
                    <td>
                        <button class="btn btn-success"
                            onclick="copyToClipboard('https://{{ DOMAIN }}/{{ url.short_code }}')">複製</button>
                        <button class="btn btn-info" data-toggle="modal" data-target="#qrcodeModal"
                            onclick="generateQRCode('{{ url.short_code }}')">QRCode</button>
                        <button class="btn btn-primary" onclick="analyzeClicks('{{ url.short_code }}')">分析</button>
                        <button class="btn btn-warning" data-toggle="modal" data-target="#editModal"
                            onclick="editUrl('{{ url.short_code }}')">編輯</button>
                        <button class="btn btn-danger" onclick="deleteUrl('{{ url.short_code }}')">刪除</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-center">您還沒有建立任何短網址</p>
        {% endif %}
    </div>
    <!-- Modal: 建立短網址 -->
    <div class="modal fade" id="createUrlModal" tabindex="-1" role="dialog" aria-labelledby="createUrlModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createUrlModalLabel">建立短網址</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- <form id="create-url-form" action="/create_short_url/" enctype="multipart/form-data" method="post"> -->
                    <form id="create-url-form" enctype="multipart/form-data"
                        onsubmit="event.preventDefault(); createShortUrl();">
                        <!-- 目的網址 -->
                        <div class="form-group">
                            <label for="target-url">目的網址</label>
                            <input type="url" class="form-control" id="target-url" name="original_url"
                                placeholder="請輸入目的網址" required>
                        </div>
                        <!-- 標題 -->
                        <div class="form-group">
                            <label for="title">標題</label>
                            <input type="text" class="form-control" id="title" name="title" placeholder="標題">
                        </div>
                        <!-- 描述 -->
                        <div class="form-group">
                            <label for="description">描述</label>
                            <textarea class="form-control" id="description" name="description"
                                placeholder="描述"></textarea>
                        </div>
                        <!-- 封面 -->
                        <div class="form-group">
                            <label for="image-preview">封面圖片</label>
                            <div id="drop-area" class="border p-3 text-center">
                                <!-- 如果是 og:image -->
                                <input type="hidden" id="og-image-url" name="og_image_url">
                                <p>拖曳圖片到這裡或點擊選擇圖片上傳</p>
                                <input type="file" id="image" name="image" class="form-control-file d-none"
                                    accept="image/*" />
                                <img id="image-preview" src="" alt="封面圖片" class="img-fluid"
                                    style="max-width: 100%; height: auto;">
                            </div>
                        </div>
                        <!-- 添加 直接跳轉Checkbox -->
                        <!-- PIXNET用戶才出現 checkbox -->
                        {% if user_email and user_email.endswith('@pixnet.tw') %}
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="direct-redirect" name="direct_redirect">
                            <label class="form-check-label" for="direct-redirect">直接跳轉到目標網址（不經過跳轉頁面）</label>
                        </div>
                        {% endif %}
                        <!-- 標籤 -->
                        <div class="form-group">
                            <label for="tags">標籤</label>
                            <input type="text" class="form-control" id="tags" name="tags" placeholder="請用半型逗號（,）隔開">
                        </div>
                        <!-- GA UTM -->
                        <!-- <div class="form-group">
                            <label>GA UTM 參數</label>
                            <input type="text" class="form-control" id="utm_source" name="utm_source" placeholder="utm_source">
                            <input type="text" class="form-control" id="utm_medium" name="utm_medium" placeholder="utm_medium">
                            <input type="text" class="form-control" id="utm_campaign" name="utm_campaign" placeholder="utm_campaign">
                            <input type="text" class="form-control" id="utm_term" name="utm_term" placeholder="utm_term">
                            <input type="text" class="form-control" id="utm_content" name="utm_content" placeholder="utm_content">
                        </div> -->
                        <button type="submit" class="btn btn-primary" onclick="createShortUrl()">建立短網址</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: 錯誤提示 -->
    <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorModalLabel">錯誤</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: 通用提示框 -->
    <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="infoModalLabel">提示</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="modalMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal: 編輯短網址 -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">編輯短網址</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 編輯表單 -->
                    <!-- <form id="edit-form" action="/update_url" enctype="multipart/form-data" method="post"> -->
                    <form id="edit-form" enctype="multipart/form-data" onsubmit="event.preventDefault(); updateUrl();">
                        <!-- 隱藏的 short_code 欄位 -->
                        <input type="hidden" id="edit-short-code" name="short_code">
                        <!-- 隱藏的 og:image 欄位 -->
                        <input type="hidden" id="og_image_url" name="og_image_url" value="">
                        <!-- 原網址 -->
                        <div class="form-group">
                            <label for="edit-original-url">原網址</label>
                            <input type="text" class="form-control" id="edit-original-url" name="original_url" disabled>
                        </div>
                        <!-- 標題 -->
                        <div class="form-group">
                            <label for="edit-title">標題</label>
                            <input type="text" class="form-control" id="edit-title" name="title">
                        </div>
                        <!-- 描述 -->
                        <div class="form-group">
                            <label for="edit-description">描述</label>
                            <textarea class="form-control" id="edit-description" name="description"></textarea>
                        </div>
                        <!-- 封面 -->
                        <div class="form-group">
                            <label for="edit-image">封面圖片</label>
                            <div id="edit-drop-area" class="border p-3 text-center">
                                <p>拖曳圖片到這裡或點擊選擇圖片上傳</p>
                                <input type="file" id="edit-image" name="image" class="form-control-file d-none"
                                    accept="image/*">
                                <img id="edit-image-preview" src="" alt="封面圖片" class="img-fluid"
                                    style="max-width: 100%; height: auto;">
                            </div>
                        </div>
                        <!-- 添加 Checkbox，用於 direct_redirect -->
                        <!-- PIXNET用戶才出現 checkbox -->
                        {% if user_email and user_email.endswith('@pixnet.tw') %}
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="edit-direct-redirect"
                                name="direct_redirect">
                            <label class="form-check-label" for="edit-direct-redirect">直接跳轉到目標網址（不經過跳轉頁面）</label>
                        </div>
                        {% endif %}
                        <!-- 標籤 -->
                        <div class="form-group">
                            <label for="edit-tags">標籤</label>
                            <input type="text" class="form-control" id="edit-tags" name="tags"
                                placeholder="請用半型逗號（,）隔開">
                        </div>
                        <!-- GA UTM -->
                        <!-- <div class="form-group">
                            <label>GA UTM 參數</label>
                            <input type="text" class="form-control" id="edit-utm-source" name="utm_source" placeholder="utm_source">
                            <input type="text" class="form-control" id="edit-utm-medium" name="utm_medium" placeholder="utm_medium">
                            <input type="text" class="form-control" id="edit-utm-campaign" name="utm_campaign" placeholder="utm_campaign">
                            <input type="text" class="form-control" id="edit-utm-term" name="utm_term" placeholder="utm_term">
                            <input type="text" class="form-control" id="edit-utm-content" name="utm_content" placeholder="utm_content">
                        </div> -->
                        <button type="submit" class="btn btn-primary">更新</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: QRCode -->
    <div class="modal fade" id="qrcodeModal" tabindex="-1" role="dialog" aria-labelledby="qrcodeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrcodeModalLabel">短網址QRCode</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="qrcode-content">
                    <!-- 這裡將顯示QRCode -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: 分析 -->
    <div class="modal fade" id="analyzeModal" tabindex="-1" role="dialog" aria-labelledby="analyzeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="analyzeModalLabel">點擊分析</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <canvas id="clicksPieChart"></canvas> <!-- 用於顯示圓餅圖 -->
                </div>
            </div>
        </div>
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mb-4">
            {% if current_page > 1 %}
            <li class="page-item">
                <a class="page-link" href="/dashboard?page={{ current_page - 1 }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% endif %}

            {% for page_num in range(1, total_pages + 1) %}
            <li class="page-item {% if page_num == current_page %}active{% endif %}">
                <a class="page-link" href="/dashboard?page={{ page_num }}">{{ page_num }}</a>
            </li>
            {% endfor %}

            {% if current_page < total_pages %} <li class="page-item">
                <a class="page-link" href="/dashboard?page={{ current_page + 1 }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
                </li>
                {% endif %}
        </ul>
    </nav>

    <!-- Footer -->
    <footer class="text-center mt-5">
        <p>Copyright © 2003 - 2024 優像數位媒體科技(股)公司</p>
    </footer>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 在頁面底部引入 app.js -->
    <script src="/static/js/app.js"></script>
    <!-- 在頁面底部引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N6PZGNGN" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
</body>

</html>